<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Lesson 2: DEV ä¸€è‡´æ€§ & Identity éªŒè¯</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --moonbeam: #53cbc9; --bg: #0b111b; }
        body { background: var(--bg); color: #e2e8f0; font-family: 'Inter', sans-serif; }
        .card { background: #161c28; border: 1px solid #2d3748; border-radius: 20px; box-shadow: 0 15px 40px rgba(0,0,0,0.5); margin-top: 40px; }
        .log-box { background: #000; color: #10b981; font-family: 'Fira Code', monospace; font-size: 12px; height: 300px; overflow-y: auto; padding: 15px; border-radius: 12px; border: 1px solid #333; }
        .balance-card { background: #1e293b; padding: 15px; border-radius: 12px; text-align: center; border: 1px solid #2d3748; }
        .btn-action { background: linear-gradient(135deg, var(--moonbeam) 0%, #3182ce 100%); border: none; font-weight: bold; color: white; padding: 15px; border-radius: 12px; transition: 0.3s; }
        .btn-action:hover { opacity: 0.9; transform: translateY(-1px); }
        .addr-box { font-family: monospace; background: #000; padding: 10px; border-radius: 8px; color: #fbd38d; font-size: 13px; border: 1px solid #333; word-break: break-all; }
    </style>
</head>
<body>

<div class="container py-5">
    <div class="card mx-auto p-4" style="max-width: 600px;">
        <h4 class="text-center mb-4" style="color: var(--moonbeam)">Lesson 2 æœ€ç»ˆéªŒè¯ (Checksum ä¿®å¤ç‰ˆ)</h4>
        
        <button id="mainBtn" class="btn-action w-100 mb-4" onclick="runValidation()">æ‰§è¡Œ DEV ä¸€è‡´æ€§ä¸ Precompile è°ƒç”¨</button>

        <div id="results" style="display: none;">
            <div class="mb-4">
                <label class="small text-secondary fw-bold mb-2">å½“å‰æ ¡éªŒåœ°å€ (EIP-55):</label>
                <div id="userAddr" class="addr-box"></div>
            </div>

            <div class="row g-3 mb-4">
                <div class="col-6">
                    <div class="balance-card">
                        <small class="text-secondary">Substrate æ¥å£</small>
                        <div id="subBal" class="h4 fw-bold mb-0" style="color: #f6ad55;">0.0</div>
                        <span class="small">DEV</span>
                    </div>
                </div>
                <div class="col-6">
                    <div class="balance-card">
                        <small class="text-secondary">EVM æ¥å£</small>
                        <div id="evmBal" class="h4 fw-bold mb-0" style="color: var(--moonbeam)">0.0</div>
                        <span class="small">DEV</span>
                    </div>
                </div>
            </div>

            <label class="small text-secondary fw-bold mb-2">æ‰§è¡Œæ—¥å¿—</label>
            <div id="logs" class="log-box"></div>
        </div>
    </div>
</div>

<script type="module">
    import { ApiPromise, WsProvider } from "https://esm.sh/@polkadot/api?bundle";
    import { ethers } from "https://esm.sh/ethers@5.7.2";

    // æ ¸å¿ƒå¸¸é‡ï¼šä½¿ç”¨ Identity Precompile (0x04) é¿å…æ›²çº¿æŠ¥é”™
    const ADDR_IDENTITY = "0x0000000000000000000000000000000000000004";
    const MOONBASE_WSS = 'wss://wss.api.moonbase.moonbeam.network';
    const MOONBASE_HTTPS = 'https://rpc.api.moonbase.moonbeam.network';

    const log = (m) => {
        const el = document.getElementById("logs");
        el.innerHTML += `[${new Date().toLocaleTimeString()}] > ${m}<br>`;
        el.scrollTop = el.scrollHeight;
    };

    window.runValidation = async function() {
        const btn = document.getElementById("mainBtn");
        btn.disabled = true;
        document.getElementById("results").style.display = 'block';
        document.getElementById("logs").innerHTML = "";
        
        try {
            // 1. è·å–å¹¶è§„èŒƒåŒ–åœ°å€ (é˜²æ­¢ Checksum æŠ¥é”™)
            if (!window.ethereum) throw new Error("æœªæ£€æµ‹åˆ° SubWallet/MetaMask");
            const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
            const rawAddr = accounts[0];
            const userAddr = ethers.utils.getAddress(rawAddr); // è½¬æ¢ä¸º EIP-55 è§„èŒƒ
            document.getElementById("userAddr").innerText = userAddr;
            log(`ä½¿ç”¨è§„èŒƒåœ°å€: ${userAddr}`);

            // 2. EVM ä½™é¢æŸ¥è¯¢
            log(`æ­£åœ¨æŸ¥è¯¢ EVM ä½™é¢...`);
            const provider = new ethers.providers.JsonRpcProvider(MOONBASE_HTTPS);
            const evmBalRaw = await provider.getBalance(userAddr);
            const evmBal = ethers.utils.formatEther(evmBalRaw);
            document.getElementById("evmBal").innerText = parseFloat(evmBal).toFixed(4);

            // 3. Substrate ä½™é¢æŸ¥è¯¢
            log(`æ­£åœ¨æŸ¥è¯¢ Substrate ä½™é¢...`);
            const api = await ApiPromise.create({ provider: new WsProvider(MOONBASE_WSS) });
            const subData = await api.query.system.account(userAddr);
            const subBal = (Number(subData.data.free.toBigInt()) / 1e18).toString();
            document.getElementById("subBal").innerText = parseFloat(subBal).toFixed(4);

            log(`------------------------------`);
            log(`Substrate ä½™é¢: ${parseFloat(subBal).toFixed(2)} DEV`);
            log(`EVM ä½™é¢: ${parseFloat(evmBal).toFixed(2)} DEV`);
            log(`------------------------------`);

            // 4. è°ƒç”¨ Identity Precompile (0x04)
            log(`æ­£åœ¨è°ƒç”¨ Identity Precompile (0x...04)...`);
            const result = await provider.call({
                to: ADDR_IDENTITY,
                data: userAddr // Identity åˆçº¦ä¼šåŸæ ·å›æ˜¾è¾“å…¥çš„æ•°æ®
            });

            // éªŒè¯å›æ˜¾ç»“æœ (å¿½ç•¥å‰å¯¼é›¶å’Œ 0x)
            const cleanResult = result.toLowerCase();
            const cleanAddr = userAddr.toLowerCase().replace('0x', '');
            
            if (cleanResult.includes(cleanAddr)) {
                log(`âœ… Precompile æˆåŠŸå›æ˜¾æ•°æ®: ${cleanResult.slice(-40)}`);
                log("<br>ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ Lesson 2 ä»»åŠ¡å½»åº•è¾¾æˆï¼ ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥");
            } else {
                log(`âš ï¸ å›æ˜¾ä¸åŒ¹é…ï¼ŒåŸå§‹è¿”å›: ${cleanResult}`);
            }

            await api.disconnect();
        } catch (e) {
            log(`âŒ éªŒè¯ä¸­æ–­: ${e.message}`);
            console.error(e);
        } finally {
            btn.disabled = false;
        }
    };
</script>
</body>
</html>
